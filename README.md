# Info Bot — информационный Telegram-бот

Telegram-бот с многоуровневым интерактивным меню, разделами и подразделами, страницей «О нас», админ-панелью (рассылка, статистика, список пользователей) и учётом переходов по deep link. Контент настраивается через YAML-файлы без изменения кода.

## Возможности

- **Команды:** `/start` — главное меню, `/info` — страница «О нас».
- **Меню:** иерархические разделы и подразделы с текстом и до 3 изображений на экран.
- **Контент из YAML:** тексты и картинки разделов задаются в `app/data/sections.yaml`.
- **Deep links:** ссылки вида `https://t.me/ВАШ_БОТ?start=SLUG` для учёта источников трафика; список slug в `app/data/deep_links.yaml`.
- **Админ-панель:** статистика (всего пользователей, по ссылкам), рассылка, выгрузка списка пользователей.
- **Логирование:** действия пользователей и ошибки в консоль и в `app/logs/`.

## Требования

- Python 3.10+
- Аккаунт Telegram и токен бота от [@BotFather](https://t.me/BotFather).

---

## Установка

### 1. Клонирование и каталог проекта

Перейдите в каталог, где будет лежать проект (например, `info_bot`), и убедитесь, что там есть все файлы бота (в том числе папка `app`, `requirements.txt`, `env_example`).

### 2. Виртуальное окружение

Рекомендуется использовать виртуальное окружение.

**Windows (PowerShell или cmd):**

```bash
python -m venv .venv
.venv\Scripts\activate
```

**Linux / macOS:**

```bash
python3 -m venv .venv
source .venv/bin/activate
```

После активации в начале строки приглашения должно появляться `(.venv)`.

На **Linux и macOS** после создания виртуального окружения можно запускать проект через скрипт **`run.sh`** (см. раздел [Запуск бота](#запуск-бота)) — он сам активирует `.venv`, при необходимости установит зависимости и запустит бота.

### 3. Установка зависимостей

Из корня проекта (там, где лежит `requirements.txt`):

```bash
pip install -r requirements.txt
```

Основные зависимости: aiogram 3, aiosqlite, SQLAlchemy, environs, PyYAML, loguru.

### 4. Переменные окружения

Файл с настройками бота: **`app/.env`** (не в корне проекта).

1. Скопируйте пример конфигурации:
   - **Windows:** `copy env_example app\.env`
   - **Linux / macOS:** `cp env_example app/.env`

2. Откройте `app/.env` и заполните:

| Переменная   | Описание |
|-------------|----------|
| `BOT_TOKEN` | Токен бота, выданный в [@BotFather](https://t.me/BotFather). |
| `ADMIN_ID`  | Ваш Telegram User ID (число). Несколько админов — через запятую без пробелов, например: `123456789,987654321`. |

**Как узнать свой Telegram ID:** напишите боту [@userinfobot](https://t.me/userinfobot) — он пришлёт ваш ID.

Пример содержимого `app/.env`:

```env
BOT_TOKEN=7123456789:AAHxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
ADMIN_ID=123456789
```

Не коммитьте файл `app/.env` в репозиторий (он уже добавлен в `.gitignore`).

---

## Настройка контента

### Разделы и приветствие — `app/data/sections.yaml`

В этом файле задаётся:

- **`welcome`** — текст и опционально картинка при `/start`.
- **`info`** — текст и картинки для команды `/info` («О нас»).
- **`sections`** — дерево разделов и подразделов.

У каждого раздела/подраздела:

- `id` — уникальный идентификатор (например, `"1"`, `"1_1"`, `"2_2"`).
- `title` — надпись на кнопке в меню.
- `text` — текст сообщения при открытии раздела.
- `images` — список до 3 элементов: URL картинок или пути к файлам (относительно корня проекта). Если картинок нет — укажите `images: []`.
- `children` — вложенные подразделы (та же структура).

Пример фрагмента:

```yaml
welcome:
  text: "Добро пожаловать! Выберите раздел в меню ниже."
  image_path: ""
  image_url: ""

info:
  text: "О нашей компании..."
  images: []

sections:
  - id: "1"
    title: "Услуги"
    text: "Описание услуг. Выберите подраздел."
    images: []
    children:
      - id: "1_1"
        title: "Услуга 1"
        text: "Текст подраздела."
        images: []
        children: []
```

Подробное описание синтаксиса и примеры — в файле **`app/data/SECTIONS_GUIDE.md`**.

### Deep links — `app/data/deep_links.yaml`

Файл задаёт список разрешённых slug для ссылок вида:

`https://t.me/ИМЯ_ВАШЕГО_БОТА?start=SLUG`

При первом запуске бота по такой ссылке в базе сохраняется, по какому slug пришёл пользователь; в админ-панели отображается статистика по ссылкам.

Формат:

```yaml
links:
  - slug: ref_123
    name: Рекламная кампания 1
  - slug: promo_2
    name: Промо 2
```

- **slug** — значение после `?start=` (латиница, цифры, подчёркивание; ограничение Telegram — до 64 байт).
- **name** — подпись в статистике админки (опционально; если не указать, в отчёте будет slug).

Добавление или удаление записей в `links` меняет набор отслеживаемых ссылок. После правки файла нужно перезапустить бота.

---

## Запуск бота

Запуск нужно выполнять **из корня проекта** (там, где находятся папки `app` и `data`).

**Вариант 1 — через Python:**

```bash
# Убедитесь, что виртуальное окружение активировано
python -m app.bot
```

**Вариант 2 — скрипт run.sh (Linux / macOS):**

```bash
chmod +x run.sh
./run.sh
```

Скрипт сам создаёт `.venv`, при необходимости ставит зависимости и запускает `python -m app.bot`.

**Вариант 3 — Windows (batch):**

Создайте `run.bat` в корне проекта или выполните вручную:

```bat
.venv\Scripts\activate
python -m app.bot
```

При успешном запуске в консоли появится сообщение о старте long polling; логи пишутся в консоль и в файлы в каталоге **`app/logs/`** (файлы по дням, ротация и хранение заданы в `app/core/logging_config.py`).

---

## Структура проекта (кратко)

| Путь | Назначение |
|------|------------|
| `app/bot.py` | Точка входа: настройка логов, загрузка конфигов, инициализация БД, регистрация роутеров, запуск polling. |
| `app/core/config_aiogram.py` | Чтение `app/.env` (BOT_TOKEN, ADMIN_ID). |
| `app/core/logging_config.py` | Настройка loguru: консоль + файлы в `app/logs/`. |
| `app/data/sections.yaml` | Контент меню и страницы «О нас». |
| `app/data/deep_links.yaml` | Список разрешённых deep link slug. |
| `app/data/loader.py` | Загрузка и разбор `sections.yaml`. |
| `app/data/deep_links_loader.py` | Загрузка и разбор `deep_links.yaml`. |
| `app/database/` | Модели, движок SQLite (по умолчанию `data/bot.db`), миграции при старте. |
| `app/handlers/` | Обработчики `/start`, `/info`, меню, админ-панели. |
| `app/keyboards/` | Inline-клавиатуры и callback_data. |
| `data/` | Создаётся при первом запуске; здесь по умолчанию лежит `bot.db`. |
| `app/logs/` | Файлы логов (создаётся при первом запуске). |

---

## Админ-панель

Доступна только пользователям, чей Telegram ID указан в `ADMIN_ID` в `app/.env`.

- В главном меню (после `/start`) у админа отображается кнопка **«Админ панель»**.
- В панели: количество пользователей, разбивка по deep link и «без ссылки», кнопки **«Рассылка»**, **«Список пользователей»**, **«Назад»**.
- **Рассылка:** нажать «Рассылка», отправить одним сообщением текст — он будет разослан всем пользователям из БД. Отмена — команда `/cancel`.
- **Список пользователей:** выгрузка в чат (id, telegram_id, username, дата, deep_link); при большом объёме сообщения разбиваются по лимиту Telegram.

---

## База данных

- По умолчанию используется SQLite: файл **`data/bot.db`** (создаётся при первом запуске).
- Таблица `users`: идентификатор, `telegram_id`, `username`, дата регистрации, `deep_link` (slug ссылки при первом входе или NULL).
- Миграции (добавление новых полей при обновлении кода) выполняются автоматически при старте бота в `app/database/__init__.py`.

---

## Логи

- **Консоль:** уровень INFO, с цветом (если терминал поддерживает).
- **Файлы:** `app/logs/bot_YYYY-MM-DD.log`, уровень DEBUG, ротация по дням, хранение 30 дней, кодировка UTF-8.

В логах фиксируются действия пользователей (старт бота, открытие «О нас», переходы по меню, действия админов и рассылка) на русском языке.

---

## Устранение неполадок

1. **Ошибка «Environment variable "BOT_TOKEN" not set»**  
   Убедитесь, что файл **`app/.env`** существует и в нём указана переменная `BOT_TOKEN` (без кавычек, без пробелов вокруг `=`).

2. **Ошибка «Environment variable "ADMIN_ID" not set»**  
   В `app/.env` должна быть строка `ADMIN_ID=ваш_telegram_id`. Несколько админов: `ADMIN_ID=123,456`.

3. **Бот не отвечает на команды**  
   Проверьте, что запускаете из корня проекта (`python -m app.bot`) и что в консоли нет исключений. Убедитесь, что токен от BotFather скопирован полностью и бот не отключён в BotFather.

4. **Не загружаются разделы или картинки**  
   Проверьте синтаксис `app/data/sections.yaml` (отступы как в примере выше). Пути к локальным картинкам — относительно корня проекта; URL должны начинаться с `http://` или `https://`.

5. **Нет кнопки «Админ панель»**  
   Ваш Telegram ID должен быть указан в `ADMIN_ID` в `app/.env`. Узнать ID можно через [@userinfobot](https://t.me/userinfobot). После смены `.env` перезапустите бота.

---

## Лицензия

Проект можно использовать и дорабатывать по своему усмотрению. При использовании библиотек (aiogram, SQLAlchemy и др.) соблюдайте их лицензии.
